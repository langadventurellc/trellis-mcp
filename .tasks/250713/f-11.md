# F-11 · Parent Deletion Cascade — Task Checklist

## Checklist

**IMPORTANT**: When starting a new task, read @../../docs/task_mcp_spec_and_plan.md for context.

- [x] **S-01** (XS) Add `errors.py` → `CascadeError` & `ProtectedObjectError`
  - Created `cascade_error.py` with `CascadeError` class for cascade deletion operation errors
  - Created `protected_object_error.py` with `ProtectedObjectError` class for protected children deletion blocking
  - Updated `__init__.py` to export both new exceptions
  - Added comprehensive unit tests for both exception classes
  - All 670 tests passing, all quality checks (format, lint, type-check) passing
- [x] **S-02** (S) Implement `fs_utils.recursive_delete(path)` with dry-run mode
  - Implemented `recursive_delete(path: Path, dry_run: bool = False) -> list[Path]` function in `fs_utils.py`
  - Added import for `shutil` module for safe directory removal
  - Function supports both single file and recursive directory deletion
  - Dry-run mode returns list of paths that would be deleted without actually deleting
  - Includes comprehensive input validation and security checks
  - Uses `shutil.rmtree` for safe recursive directory removal
  - Added 12 comprehensive unit tests covering all scenarios (single files, directories, nested structures, Trellis hierarchy, error cases, special characters)
  - All 682 tests passing, all quality checks (format, lint, type-check) passing
- [x] **S-03** (S) Extend `path_resolver.children_of(kind, id)` → list descendant paths
  - Implemented `children_of(kind: str, obj_id: str, project_root: Path) -> list[Path]` function in `path_resolver.py`
  - Function returns all descendant paths for a given object in the hierarchical structure
  - For projects: Returns all epics, features, and tasks under the project
  - For epics: Returns all features and tasks under the epic
  - For features: Returns all tasks under the feature
  - For tasks: Returns empty list (tasks have no children)
  - Added helper function `_add_tasks_from_feature()` to collect tasks from both tasks-open and tasks-done directories
  - Includes comprehensive input validation and error handling
  - Returns paths in sorted order for consistent output
  - Added 22 comprehensive unit tests covering all scenarios (complete hierarchies, empty objects, error cases, edge cases, complex hierarchies, ID prefix handling)
  - All 703 tests passing, all quality checks (format, lint, type-check) passing
- [x] **S-04** (S) Update `updateObject` RPC: when patch sets `status=deleted`, invoke cascade
  - Added cascade deletion logic to `updateObject` RPC method in `server.py`
  - Detects when `yamlPatch` contains `status=deleted` and triggers cascade deletion
  - Uses `children_of()` to find all descendant paths of the object being deleted
  - Checks for protected children (tasks with `in-progress` or `review` status)
  - Raises `ProtectedObjectError` if protected children exist, preventing deletion
  - Performs cascade deletion using `recursive_delete()` if no protected children
  - Returns comprehensive result with list of deleted paths in `cascade_deleted` field
  - Integrates with existing error handling by wrapping exceptions in `TrellisValidationError`
  - All 703 tests passing, all quality checks (format, lint, type-check) passing
- [x] **S-05** (XS) Safeguard: abort if any child Task is `in-progress` or `review`
  - Added `force` parameter to `updateObject` method with default value `False`
  - Updated method documentation to describe the force parameter behavior
  - Modified safeguard logic to check force flag before raising `ProtectedObjectError`
  - When `force=False` (default): Raises `ProtectedObjectError` if protected children exist
  - When `force=True`: Bypasses safeguard and proceeds with cascade deletion
  - All 703 tests passing, all quality checks (format, lint, type-check) passing
- [x] **S-06** (XS) CLI: add `--force` flag to `trellis-mcp delete` sub-command
  - Added new `delete` sub-command to CLI with kind and object_id arguments
  - Implemented `--force` flag to bypass protected children safeguards
  - Command calls `updateObject` with `status=deleted` and `force` parameter
  - Follows same error handling and output patterns as other CLI commands
  - Provides comprehensive help text with examples for all object types
  - All 703 tests passing, all quality checks (format, lint, type-check) passing
- [x] **S-07** (S) CLI prompt ("⚠️  Delete Epic E-foo and 7 descendants? [y/N]")
  - Added confirmation prompt to CLI delete command using `click.confirm()`
  - Implemented descendant counting using `children_of()` function before deletion
  - Shows appropriate message: "⚠️  Delete Epic E-foo and 7 descendants? [y/N]" when descendants exist
  - Shows simpler message: "⚠️  Delete Epic E-foo? [y/N]" when no descendants exist
  - Gracefully handles user cancellation with `click.Abort` exception
  - Maintains all existing functionality and error handling patterns
  - All 703 tests passing, all quality checks (format, lint, type-check) passing
- [x] **S-08** (XS) Unit tests: dry-run returns correct deletion list
  - Added `test_recursive_delete_dry_run_matches_actual_deletion` test function in `test_fs_utils.py`
  - Test verifies that dry-run returns identical deletion list to actual deletion mode
  - Creates identical directory structures in separate temp directories 
  - Compares dry-run results with actual deletion results to ensure consistency
  - Validates same number of paths, same relative structure, and same ordering
  - Ensures all paths are resolved absolute paths as required by the function
  - All 704 tests passing, all quality checks (format, lint, type-check) passing
- [x] **S-09** (S) Unit tests: protected child in progress → raises `ProtectedObjectError`
  - Added `TestProtectedObjectDeletion` class to `test_server.py` with comprehensive test coverage
  - Implemented tests for various scenarios: epic/feature/project deletion with protected tasks
  - Tests verify `ProtectedObjectError` is raised when attempting to delete objects with tasks in `in-progress` or `review` status
  - Tests verify force deletion bypasses the protection mechanism
  - Tests verify correct error messages are generated
  - Added `StatusEnum.DELETED` to status enum and allowed statuses for all object kinds
  - Updated transition matrices in all schema models to allow transitions to `deleted` from any status
  - Fixed validation logic to support cascade deletion functionality
  - Updated existing validation tests to reflect new transition behavior (done → deleted is now valid)
  - All new tests passing: 5 tests added covering epic, feature, project deletion scenarios
  - All existing tests updated and passing: 101 validation tests, 709 total tests
- [x] **S-10** (M) Integration test: create nested Project→Epic→Feature→Task tree, delete Epic, verify repo contains no orphan files/folders
  - Implemented `test_parent_deletion_cascade_integration` in `tests/integration/test_crud_operations.py`
  - Creates complete Project→Epic→Feature→Task hierarchy with tasks in both open and done states
  - Uses `updateObject` with `status=deleted` to trigger cascade deletion of epic
  - Verifies all .md files are properly deleted from the filesystem
  - Confirms no orphan files remain in the repository structure
  - Ensures parent project remains intact and functional after deletion
  - Validates cascade_deleted response contains all expected deleted file paths
  - Fixed CLI delete command to properly use FastMCP client interface
  - Test passes comprehensive verification of cascade deletion functionality
  - All 711 tests passing, all quality checks (format, lint, type-check) passing
- [x] **S-11** (XS) Docs: update Quick-start & README with deletion example
  - Added comprehensive deletion examples to README.md Quick Start section (step 5)
  - Demonstrated basic task deletion, feature/epic deletion with confirmation prompts 
  - Showed cascade deletion output with example file listings
  - Included --force flag usage for protected children scenarios
  - Examples match actual CLI command syntax and expected output format
  - All 710 tests passing, all quality checks (format, lint, type-check) passing

### Quality Gates
* No orphan files remain after deletion.
* Deleting a parent with active (`in-progress`/`review`) children is blocked unless `--force`.
* All tests & pre-commit hooks pass on CI matrix.

### Relevant Files
* `/src/trellis_mcp/exceptions/cascade_error.py` - CascadeError exception class
* `/src/trellis_mcp/exceptions/protected_object_error.py` - ProtectedObjectError exception class  
* `/src/trellis_mcp/exceptions/__init__.py` - Updated exports for new exceptions
* `/tests/unit/test_exceptions.py` - Unit tests for new exception classes
* `/src/trellis_mcp/fs_utils.py` - Added recursive_delete function with dry-run mode
* `/tests/unit/test_fs_utils.py` - Added comprehensive unit tests for recursive_delete function, including test that verifies dry-run returns identical deletion list to actual deletion
* `/src/trellis_mcp/path_resolver.py` - Added children_of function and _add_tasks_from_feature helper function
* `/tests/unit/test_path_resolver.py` - Added comprehensive unit tests for children_of function
* `/src/trellis_mcp/server.py` - Added cascade deletion logic to updateObject RPC method, added force parameter to bypass safeguards
* `/src/trellis_mcp/cli.py` - Added delete sub-command with --force flag that calls updateObject with status=deleted, added confirmation prompt with descendant counting
* `/src/trellis_mcp/schema/status_enum.py` - Added StatusEnum.DELETED for cascade deletion support
* `/src/trellis_mcp/schema/base_schema.py` - Added StatusEnum.DELETED to allowed statuses for all object kinds
* `/src/trellis_mcp/schema/project.py` - Updated transition matrix to allow transitions to deleted from any status
* `/src/trellis_mcp/schema/epic.py` - Updated transition matrix to allow transitions to deleted from any status
* `/src/trellis_mcp/schema/feature.py` - Updated transition matrix to allow transitions to deleted from any status
* `/src/trellis_mcp/schema/task.py` - Updated transition matrix to allow transitions to deleted from any status
* `/tests/unit/test_server.py` - Added TestProtectedObjectDeletion class with comprehensive tests for ProtectedObjectError scenarios
* `/tests/unit/test_validation.py` - Updated existing validation tests to reflect new transition behavior (done → deleted is now valid)
* `/tests/integration/test_crud_operations.py` - Added test_parent_deletion_cascade_integration integration test for complete cascade deletion verification
* `/README.md` - Added comprehensive deletion examples to Quick Start section demonstrating CLI delete command usage
