# F-08 · Review Query — Task Checklist

## Checklist

**IMPORTANT**: When starting a new task, read @../../docs/task_mcp_spec_and_plan.md for context.

- [x] **S-01** (XS) Create `is_reviewable(obj)` function
  - Created `src/trellis_mcp/query.py` with `is_reviewable()` function
  - Function checks if object status equals `StatusEnum.REVIEW`
  - Added comprehensive unit tests covering review/non-review statuses and different object types
  - All quality checks pass (format, lint, type-check, tests)
- [x] **S-02** (S) Add `query.py:get_oldest_review(projectRoot)` — scans features/tasks and picks earliest `updated` timestamp (ties broken by priority)
  - Implemented `get_oldest_review(project_root: Path) -> TaskModel | None` function in `src/trellis_mcp/query.py`
  - Function scans all tasks across project hierarchy (Projects → Epics → Features → Tasks)
  - Filters for tasks with `status == StatusEnum.REVIEW` using existing `is_reviewable()` function
  - Sorts by `updated` timestamp (oldest first), with priority as tiebreaker (HIGH=1, NORMAL=2, LOW=3)
  - Returns `None` when no reviewable tasks exist (meets quality gate requirement)
  - Added necessary imports: `Path`, `parse_object`, `TaskModel`
  - All quality checks pass: ✅ Format ✅ Lint ✅ Type-check ✅ Tests (555/555 passing)
- [x] **S-03** (S) Implement RPC `getNextReviewableTask` wiring → `query.get_oldest_review`
  - Implemented `getNextReviewableTask` RPC method in `src/trellis_mcp/server.py` using `@server.tool` decorator
  - Method calls existing `query.get_oldest_review(project_root_path)` function to find oldest reviewable task
  - Returns `{"task": None}` when no reviewable tasks exist (meets quality gate requirement)
  - Returns structured task dictionary with id, title, status, priority, parent, file_path, created, updated when task found
  - Added proper parameter validation (projectRoot cannot be empty)
  - Added comprehensive error handling with `TrellisValidationError` for any query/path resolution failures
  - Added import for `get_oldest_review` from `.query` module
  - All quality checks pass: ✅ Format ✅ Lint ✅ Type-check ✅ Tests (555/555 passing)
- [x] **S-04** (XS) Update FastMCP service registry to expose new RPC
  - Verified that `getNextReviewableTask` RPC method is automatically exposed through the `@server.tool` decorator
  - Confirmed tool is discoverable in FastMCP service registry alongside 7 other tools (claimNextTask, completeTask, createObject, getObject, health_check, listBacklog, updateObject)
  - Verified tool has proper description, parameter schema (projectRoot), and return type documentation
  - All quality checks pass: ✅ Format ✅ Lint ✅ Type-check ✅ Tests (555/555 passing)
- [x] **S-05** (XS) Unit tests: no review tasks → returns `None`; one → returns it; multiple → returns oldest/highest-priority
  - Added comprehensive unit tests for `get_oldest_review()` function covering all required scenarios
  - `test_get_oldest_review_no_review_tasks()`: Tests empty directories, no tasks, and tasks with non-review status
  - `test_get_oldest_review_single_review_task()`: Tests single task in review status is correctly returned
  - `test_get_oldest_review_multiple_tasks_oldest_first()`: Tests oldest updated timestamp selection
  - `test_get_oldest_review_priority_tiebreaker()`: Tests priority as tiebreaker when timestamps equal (HIGH > NORMAL > LOW)
  - All quality checks pass: ✅ Format ✅ Lint ✅ Type-check ✅ Tests (559/559 passing)
- [x] **S-06** (M) Integration test: create sample repo with mixed status tasks, call RPC via FastMCP test client, assert correct task ID returned
  - Implemented comprehensive integration test `test_getNextReviewableTask_integration_with_mixed_status_tasks()` in `/Users/zach/code/trellis-mcp/tests/test_integration.py`
  - Test creates a full project hierarchy (Project → Epic → Feature → Tasks) with mixed status tasks (open, in-progress, review)
  - Verifies `getNextReviewableTask` RPC returns correct task based on oldest updated timestamp with priority tiebreaker
  - Tests three scenarios: high priority review task returned first, normal priority returned second, and `{"task": None}` when no reviewable tasks remain
  - Uses proper status transition sequence (open → in-progress → review) to comply with validation rules
  - All quality checks pass: ✅ Format ✅ Lint ✅ Type-check ✅ Tests (560/560 passing)
- [x] **S-07** (XS) Docs: add code snippet to Quick-start showing how to call `getNextReviewableTask` via mcp-inspector
  - Added step 4 to Quick Start section in `/Users/zach/code/trellis-mcp/README.md` demonstrating mcp-inspector usage
  - Included both visual testing mode and CLI mode examples for calling `getNextReviewableTask` RPC method
  - Added example JSON outputs showing both success case (task found) and no-tasks case (`{"task": null}`)
  - Followed existing documentation patterns with bash code blocks and proper formatting
  - All quality checks pass: ✅ Format ✅ Lint ✅ Type-check ✅ Tests (560/560 passing)

### Quality Gates

- Function returns **`None`** (JSON-null) when no reviewable tasks exist.
- Ordering: priority (`high` < `normal` < `low`) first, then oldest `updated`.
- Unit + integration tests green on CI, coverage ≥ 90 % for new functions.
- No performance regression: query runs < 50 ms on 2 k task repo in CI benchmark.

## Relevant Files

- `src/trellis_mcp/query.py` - Query utility functions including `is_reviewable()` and `get_oldest_review()`
- `src/trellis_mcp/server.py` - FastMCP server with RPC methods including `getNextReviewableTask`
- `tests/test_query.py` - Unit tests for query utilities including comprehensive tests for `get_oldest_review()`
- `tests/test_integration.py` - Integration tests including comprehensive test for `getNextReviewableTask` RPC method
- `README.md` - Project documentation with Quick Start section including mcp-inspector usage examples
