# F-05 · Priority Handling — Task Checklist

## Checklist

**IMPORTANT**: When starting a new task, read @../../docs/task_mcp_spec_and_plan.md for context.

- [x] **S-01** (XS) Add `Priority` `Enum` (`high=1, normal=2, low=3`) in `models/common.py`

  **Implementation Summary**: Created `src/trellis_mcp/models/` directory structure with `__init__.py` and `common.py`. Implemented `Priority(IntEnum)` with `HIGH=1`, `NORMAL=2`, `LOW=3` for task sorting purposes. This integer-based enum complements the existing string-based `PriorityEnum` in the schema package.

  **Files Changed**:
  - `src/trellis_mcp/models/__init__.py` (created)
  - `src/trellis_mcp/models/common.py` (created)

  **Quality Checks**: ✅ Format ✅ Lint ✅ Type Check ✅ Tests ✅ Build
- [x] **S-02** (S) Update YAML schema loader: validate field, set default=`normal`

  **Implementation Summary**: Added explicit priority field validation and default setting to the YAML schema loader. Implemented `validate_priority_field()` function that sets missing priority fields to "normal" and validates priority enum values. Integrated this validation into `validate_front_matter()` to ensure priority validation happens during YAML loading while avoiding duplicate error reporting. The implementation ensures that priority field validation and default value setting occurs at the YAML schema loading level as requested.

  **Files Changed**:
  - `src/trellis_mcp/validation.py` (added `validate_priority_field()` function and integrated it into `validate_front_matter()`)

  **Quality Checks**: ✅ Format ✅ Lint ✅ Type Check ✅ Tests ✅ Build
- [x] **S-03** (XS) Migrate existing test fixtures → inject default `priority`

  **Implementation Summary**: Research confirmed that all existing test fixtures already include priority fields. No migration was needed as the codebase already has comprehensive priority field coverage across all test scenarios including object parser tests, integration tests, validation tests, and server tests. All 69 test fixtures found contain proper priority field values (high/normal/low).

  **Files Changed**: None (no changes required)

  **Quality Checks**: ✅ Research Complete ✅ All fixtures verified
- [x] **S-04** (S) Modify `claimNextTask`: sort candidate tasks by `(priority, created)`

  **Implementation Summary**: Implemented complete `claimNextTask` RPC method in `server.py`. The method atomically selects the highest-priority open task with all prerequisites completed, sorts by `(priority, created)` order (high=1, normal=2, low=3), validates prerequisites using existing graph infrastructure, and updates task status to `in-progress` with optional worktree stamping. Uses direct filesystem traversal for task discovery and existing validation/I/O utilities for robust operation.

  **Files Changed**:
  - `src/trellis_mcp/server.py` (added `claimNextTask` method with full prerequisite checking, priority sorting, and atomic task claiming)

  **Quality Checks**: ✅ Format ✅ Lint ✅ Type Check ✅ Tests ✅ Build
- [x] **S-05** (XS) Update `listBacklog` to accept `sortByPriority` flag (default true)

  **Implementation Summary**: Added `sortByPriority: bool = True` parameter to `listBacklog` RPC method. When `sortByPriority=True` (default), tasks are sorted by priority (high=1, normal=2, low=3) then by creation date as before. When `sortByPriority=False`, tasks preserve their original discovery order from filesystem traversal. This maintains backward compatibility while enabling clients to request unsorted task lists when needed. Updated docstring to document the new parameter.

  **Files Changed**:
  - `src/trellis_mcp/server.py` (added `sortByPriority` parameter to `listBacklog` function with conditional sorting logic)

  **Quality Checks**: ✅ Format ✅ Lint ✅ Type Check ✅ Tests ✅ Build
- [x] **S-06** (S) Unit tests: create mixed-priority tasks, assert selection order

  **Implementation Summary**: Created comprehensive unit tests for `claimNextTask` priority-based task selection in `TestClaimNextTaskPriority` class. Tests verify that tasks are claimed in priority order (high → normal → low), with creation date as tiebreaker for same priority tasks. Fixed critical bug in `claimNextTask` implementation where `id_to_path` parameters were in wrong order. Tests cover: highest priority selection, creation date tiebreaking, sequential claiming order, and proper error handling when no tasks available.

  **Files Changed**:
  - `tests/test_server.py` (added `TestClaimNextTaskPriority` class with 4 comprehensive test methods and helper functions)
  - `src/trellis_mcp/server.py` (fixed bug in `claimNextTask` method: corrected `id_to_path` parameter order from `(path, task_id, "task")` to `(path, "task", task_id)`)

  **Quality Checks**: ✅ Format ✅ Lint ✅ Type Check ✅ Tests ✅ Build
- [x] **S-07** (M) Integration test: two agents claim sequentially, verify high-before-low

  **Implementation Summary**: Created comprehensive integration test `test_two_agents_claim_tasks_sequentially_verify_priority_order` in `test_integration.py`. The test simulates two agents claiming tasks sequentially using separate FastMCP client connections, verifying that high-priority tasks are claimed before low-priority tasks across both agents. Test creates 4 tasks (2 high, 1 normal, 1 low priority) and verifies: priority ordering (high→high→normal→low), proper worktree stamping, alternating agent assignments, task atomicity, and proper error handling when no tasks remain.

  **Files Changed**:
  - `tests/test_integration.py` (added `test_two_agents_claim_tasks_sequentially_verify_priority_order` integration test function)

  **Quality Checks**: ✅ Format ✅ Lint ✅ Type Check ✅ Tests ✅ Build
- [x] **S-08** (XS) CLI: add `--priority` option to `createObject` shortcut (if present)

  **Implementation Summary**: Research confirmed that no CLI `createObject` shortcut exists in the current codebase. The `createObject` functionality is exclusively available through the MCP JSON-RPC interface in `server.py` (which already supports priority parameter). Since the task is conditional "(if present)" and no CLI shortcut exists, no implementation was required.

  **Files Changed**: None (no CLI shortcut exists to modify)

  **Quality Checks**: ✅ Research Complete ✅ Conditional task requirement not met
- [x] **S-09** (XS) Docs: README & Quickstart examples show priority field

  **Implementation Summary**: Added priority field examples to README.md Quick Start section. Created step 3 showing practical YAML front-matter examples for creating tasks and features with priority fields. Examples demonstrate both high and normal priority usage, following the project's existing concise documentation style and YAML format patterns.

  **Files Changed**:
  - `README.md` (added Quick Start step 3 with priority field examples using YAML front-matter format)

  **Quality Checks**: ✅ Format ✅ Lint ✅ Type Check ✅ Tests ✅ Build
- [x] **S-10** (XS) Refactor sort logic to use Priority enum directly for better maintainability

  **Implementation Summary**: Refactored hardcoded priority-to-integer mapping dictionaries in both `listBacklog` and `claimNextTask` functions to use the `Priority` enum directly. Replaced `priority_order = {"high": 1, "normal": 2, "low": 3}` with `Priority[task["priority"].upper()].value` approach. Added proper error handling with try/except for KeyError and AttributeError, defaulting to `Priority.NORMAL.value` for invalid values. This ensures sorting logic stays synchronized with the enum definition and improves maintainability as suggested by Gemini code review.

  **Files Changed**:
  - `src/trellis_mcp/server.py` (added Priority import and updated both sort_key functions to use enum directly)

  **Quality Checks**: ✅ Format ✅ Lint ✅ Type Check ✅ Tests ✅ Build

### Quality Gates
* Creating an object with invalid priority raises `ValidationError`.
* `claimNextTask` always returns the highest available priority.
* `listBacklog(sortByPriority=false)` preserves original order.
* Unit + integration tests pass on CI; coverage ≥ 90 % of the new code.
