# F-02 · Path & ID Management — Task Checklist

## Checklist

**IMPORTANT**: When starting a new task, read @../../docs/task_mcp_spec_and_plan.md for context.

- [x] **S-01** (S) `id_utils.py` – slugify helper, validate charset, max length

  **Implementation Summary:**
  - Created `src/trellis_mcp/id_utils.py` with three main functions:
    - `slugify_text()` - converts text to URL-safe slugs using python-slugify library
    - `validate_id_charset()` - validates IDs contain only a-z, 0-9, and hyphens
    - `validate_id_length()` - validates IDs are ≤ 32 characters
  - Added `python-slugify>=8.0.4` dependency for robust Unicode handling
- [x] **S-02** (XS) `id_utils.generate_id(kind, title)` – auto-slug + collision check
  - Added `generate_id(kind, title, project_root)` function to `src/trellis_mcp/id_utils.py`
  - Generates unique IDs using existing `slugify_text()` function as base
  - Implements collision detection by checking filesystem for existing objects
  - Handles collisions by adding numeric suffixes (-1, -2, etc.) while respecting 32-character limit
  - Supports all object kinds: project, epic, feature, task
  - Added `DuplicateIDError` exception for unresolvable collisions
- [x] **S-03** (S) `path_resolver.py` – `id_to_path(projectRoot, kind, id)` → filepath
  - Created `src/trellis_mcp/path_resolver.py` with `id_to_path()` function that converts object IDs to filesystem paths
  - Function scans the hierarchical directory structure to locate objects by ID (similar to `_id_exists` in `id_utils.py`)
  - Supports all object kinds: project, epic, feature, task with proper path resolution
  - For tasks, checks both tasks-open and tasks-done directories, preferring tasks-open
  - Handles ID prefix stripping (P-, E-, F-, T-) automatically
- [x] **S-04** (XS) `path_resolver.path_to_id()` – reverse mapping for look-ups
  - Added `path_to_id(file_path)` function to `src/trellis_mcp/path_resolver.py` that converts filesystem paths to object kind and ID
  - Function performs reverse mapping of `id_to_path()` by parsing path structure and extracting object type and ID
  - Handles all object types: project, epic, feature, task (both tasks-open and tasks-done with timestamps)
- [x] **S-05** (XS) `fs_utils.ensure_parent_dirs(path)` – mkdirs for new object files
  - Created `src/trellis_mcp/fs_utils.py` with `ensure_parent_dirs(path)` function
  - Function takes a `pathlib.Path` object and creates all parent directories using `path.parent.mkdir(parents=True, exist_ok=True)`
- [x] **S-06** (XS) Hook into `createObject` RPC to call `generate_id` when no ID supplied
  - Added `createObject` RPC method to `src/trellis_mcp/server.py` as a FastMCP tool
  - Automatically calls `generate_id(kind, title, project_root)` when no ID is provided
  - Supports all object kinds: project, epic, feature, task with proper validation
  - Creates files with correct YAML front-matter and Markdown structure according to spec
  - Implements proper parent validation and path resolution using existing utilities
  - Uses `ensure_parent_dirs()` for directory creation and `id_to_path()` for parent resolution
- [x] **S-07** (XS) Unit tests for slug rules & collision detection  
  - Added comprehensive unit tests for slug rules and collision detection edge cases
  - Added 9 new test methods to `TestGenerateId` class covering:
    - Multi-level collision detection with suffixes (-1, -2, -3, -4, etc.)
    - Suffix truncation edge cases when base slug + suffix exceeds 32 characters
    - DuplicateIDError boundary testing at 100 attempts limit
    - Cross-hierarchy collision detection (same ID across different object types)
    - Complex Unicode character handling (Cyrillic, Chinese, Arabic, emoji)
    - Boundary condition testing (32-char limits, single chars, numbers)
    - Malformed directory structure handling
    - Single character slug collision resolution
    - Validation preservation during collision resolution
- [x] **S-08** (XS) Unit tests for path ↔ ID round-trip on every kind (P/E/F/T)  
  - Created dedicated `TestRoundTripConversion` test class with comprehensive round-trip tests
  - Added 19 new test methods using parametrized tests to cover all object kinds (P/E/F/T)
  - Tests verify the invariant: `path_to_id(id_to_path(project_root, kind, obj_id)) == (kind, obj_id)`
  - Coverage includes: simple IDs, complex IDs with hyphens, IDs with prefixes, edge cases
  - Tests both tasks-open and tasks-done directories, verifying precedence behavior
- [x] **S-09** (M) Integration test: create two tasks with same title, verify unique IDs & correct paths
  - Added comprehensive integration test `test_create_duplicate_title_tasks_generates_unique_ids` to `tests/test_integration.py`
  - Test creates complete project hierarchy (project → epic → feature) using `createObject` RPC method
  - Creates two tasks with identical title "Implement Authentication" under the same feature
  - Verifies first task gets base slug ID: "T-implement-authentication"
  - Verifies second task gets collision-resolved ID: "T-implement-authentication-1"
  - Verifies both tasks have correct file paths in the expected directory structure
  - Verifies both task files exist on filesystem with proper YAML front-matter
  - Test validates end-to-end collision detection functionality through the RPC API

### Quality Gates
* IDs are lowercase a-z, 0-9, "-", length ≤ 32.
* `id_to_path` respects the nested layout defined in spec v 1.1.
* `path_to_id(id_to_path(…)) == id` for all test cases.
* Collision raises `DuplicateIDError`.
* Tests & pre-commit hooks pass on CI matrix.

### Relevant Files
* `src/trellis_mcp/id_utils.py` - Enhanced with `generate_id()` function and `DuplicateIDError` exception
* `tests/test_id_utils.py` - Added comprehensive tests for ID generation and collision detection
* `src/trellis_mcp/path_resolver.py` - Enhanced with `id_to_path()` and `path_to_id()` functions for bidirectional path/ID conversion
* `tests/test_path_resolver.py` - Enhanced with comprehensive unit tests for path resolution functionality including round-trip validation and new dedicated TestRoundTripConversion class with 19 test methods
* `src/trellis_mcp/fs_utils.py` - Created with `ensure_parent_dirs()` function for creating parent directories
* `tests/test_fs_utils.py` - Added comprehensive unit tests for filesystem utilities
* `src/trellis_mcp/server.py` - Enhanced with `createObject` RPC method that automatically generates IDs when not provided
* `tests/test_integration.py` - Enhanced with comprehensive integration test for duplicate task title collision detection
* `pyproject.toml` - Updated flake8 configuration to ignore E203 and W503 for Black/Flake8 compatibility
