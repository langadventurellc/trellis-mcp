# F-09 · Backlog Listing — Task Checklist

## Checklist

**IMPORTANT**: When starting a new task, read @../../docs/task_mcp_spec_and_plan.md for context.

- [x] **S-01** (XS) Define `FilterParams` dataclass (status[], priority[]) with validation
  - Implemented FilterParams Pydantic model with validation for status and priority lists
  - Added comprehensive tests covering all validation scenarios
  - Files: src/trellis_mcp/models/filter_params.py, tests/test_filter_params.py
- [x] **S-02** (S) Implement `scanner.py` — walk nested planning tree and yield task front-matters
  - Implemented `scan_tasks()` function that walks the nested planning tree structure
  - Traverses: planning/projects/P-*/epics/E-*/features/F-*/tasks-open/ and tasks-done/
  - Parses YAML front-matter using existing `parse_object()` infrastructure
  - Gracefully handles missing directories and unparseable files
  - Includes security checks to prevent path traversal attacks
  - Comprehensive test coverage with 9 test cases covering various scenarios
  - Files: src/trellis_mcp/scanner.py, tests/test_scanner.py
- [x] **S-03** (XS) Add `filter_by_scope(root, scopeId)` helper (project/epic/feature)
  - Implemented `filter_by_scope()` function in `src/trellis_mcp/filters.py`
  - Function takes project root path and scope ID, returns tasks matching the scope
  - Supports hierarchical filtering: project scope includes all child epics/features/tasks
  - Epic scope includes all child features/tasks, feature scope includes direct tasks
  - Also matches tasks where scope_id is the direct parent
  - Follows existing patterns from server.py scope filtering logic
  - Includes comprehensive test coverage with 11 test cases
  - Files: src/trellis_mcp/filters.py, tests/test_filters.py
- [x] **S-04** (S) Add `apply_filters(tasks, FilterParams)` — status/priority matching
  - Implemented `apply_filters()` function in `src/trellis_mcp/filters.py`
  - Function takes an Iterator of TaskModel objects and FilterParams, returns filtered Iterator
  - Supports filtering by status and priority lists (empty lists = no filtering)
  - Applies filters as logical AND (task must match both status AND priority if both specified)
  - Gracefully handles parsing errors by skipping invalid tasks
  - Follows existing patterns from filter_by_scope() and other filtering functions
  - Comprehensive test coverage with 11 test cases covering all filtering scenarios
  - Files: src/trellis_mcp/filters.py, tests/test_filters.py
- [x] **S-05** (XS) Sorting util: primary = priority enum; secondary = `created`
  - Implemented `task_sort_key()` function in `src/trellis_mcp/models/task_sort_key.py`
  - Function returns tuple of (priority_rank, created_datetime) for use with sorted()
  - Primary sort: Priority ranking (high=1, normal=2, low=3) - lower values first
  - Secondary sort: Creation date - older tasks first
  - Added to models package exports for easy import
  - Comprehensive test coverage with 5 test cases covering all sorting scenarios
  - Files: src/trellis_mcp/models/task_sort_key.py, tests/test_task_sort_key.py
- [x] **S-06** (XS) Wire `listBacklog` RPC → path scanner → filters → sort → JSON-serialisable return
  - Replaced manual directory traversal with modular components (scanner, filters, sort)
  - Added path resolution logic to handle both planning root and planning directory scenarios
  - Properly wired scan_tasks() → filter_by_scope()/apply_filters() → task_sort_key() → JSON conversion
  - All 13 listBacklog tests passing, handles scope/status/priority filtering and sorting correctly
  - Files: src/trellis_mcp/server.py (listBacklog function)
- [x] **S-07** (S) Unit tests: scope filter, status filter, priority filter, combined filters
  - Enhanced existing comprehensive test suite with 5 additional unit tests
  - Added comprehensive combined filter matrix testing (multiple status + multiple priority values)
  - Added edge case tests for empty filter lists combined with populated lists
  - Added security testing for additional path traversal scenarios
  - Added iterator error propagation testing for robustness
  - Total coverage: 26 unit tests in tests/test_filters.py covering all filter scenarios
  - Files: tests/test_filters.py
- [x] **S-08** (XS) Unit test: sort order with mixed priorities
  - Added comprehensive test `test_comprehensive_mixed_priority_sorting()` to `tests/test_task_sort_key.py`
  - Tests all three priority levels (HIGH, NORMAL, LOW) with multiple tasks at each level
  - Verifies chronological ordering within each priority group
  - Tests edge cases like identical creation times for tasks with same priority
  - Confirms overall priority ordering: HIGH → NORMAL → LOW, with older tasks first within each priority
  - Files: tests/test_task_sort_key.py
- [x] **S-09** (M) Integration test: create sample hierarchy, call RPC, assert correct list & order
  - Implemented comprehensive integration test `test_listBacklog_comprehensive_integration_with_hierarchy_and_sorting`
  - Creates complex hierarchy: 2 projects, multiple epics/features, 15 tasks with varied priorities/statuses
  - Tests all filtering combinations: scope (project/epic/feature), status, priority, and combined filters
  - Validates comprehensive sorting: high→normal→low priority, older tasks first within each priority
  - Tests cross-directory search (tasks-open and tasks-done), empty results, edge cases
  - Verifies complete task data structure and field completeness
  - All 619 tests pass including the new comprehensive integration test
  - Files: tests/test_integration.py
- [x] **S-10** (XS) CLI convenience: `trellis-mcp backlog [--scope F-foo] [--status open] [--priority high]`
  - Implemented CLI command with Click framework following existing patterns
  - Added support for optional filters: --scope, --status, --priority
  - Implemented default behavior: returns only "open" tasks when no status filter specified
  - Added comprehensive error handling with click.ClickException
  - Output formatted as JSON to match RPC response format
  - All existing quality checks pass (format, lint, type-check, tests)
  - Added comprehensive test coverage with 9 test cases
  - Files: src/trellis_mcp/cli.py, tests/test_cli.py
- [x] **S-11** (XS) Fix type annotation consistency in FilterParams
  - Fixed inconsistency between `Sequence[StatusEnum | str] | None` with `default_factory=list`
  - Updated to `Sequence[StatusEnum | str]` with `default=[]` for consistent behavior
  - Type annotations now properly match the actual default behavior
  - Validators still handle None input gracefully, maintaining backward compatibility
  - All 634 tests passing, functionality preserved
  - Files: src/trellis_mcp/models/filter_params.py
- [x] **S-12** (XS) Improve docstring conciseness across modules
  - Made docstrings more concise while maintaining clarity across all target modules
  - Removed verbose "Note" sections and integrated key information into main descriptions
  - Simplified validator docstrings to one-line descriptions
  - Removed unnecessary examples and detailed explanations
  - All quality checks pass: format, lint, type-check, tests (634 tests passing)
  - Files: src/trellis_mcp/filters.py, src/trellis_mcp/scanner.py, src/trellis_mcp/models/filter_params.py, src/trellis_mcp/models/task_sort_key.py

### Quality Gates
* `listBacklog` response ≤ 500 ms for 5 000 tasks on dev machine.
* Empty filter returns **only open tasks** by default, sorted high→low priority.
* Combined filters behave as logical AND.
* CLI output matches RPC (JSON printed to stdout).
* All unit + integration tests pass, coverage ≥ 90 %.
