# F-06 · Task Claim Logic — Task Checklist

## Checklist

**IMPORTANT**: When starting a new task, read @../../docs/task_mcp_spec_and_plan.md for context.

- [x] **C-01** (XS) Add enum→int mapping (`priority_rank`) to `models.py`
  - Created `src/trellis_mcp/models.py` with `priority_rank()` function
  - Function converts Priority enum, string, or None to integer rank (high=1, normal=2, low=3)
  - Handles edge cases and provides clear error messages for invalid inputs
  - All quality checks pass: formatting, linting, type checking, and tests (475 passed)
- [x] **C-02** (S) Build `backlog_loader.py` – scan `tasks-open/` under all features, return Task objects
  - Created `src/trellis_mcp/backlog_loader.py` with `load_backlog_tasks()` function
  - Function scans hierarchical project structure (Projects → Epics → Features → Tasks-open)
  - Parses task markdown files using existing `object_parser.parse_object()` utility
  - Returns list of TaskModel objects representing all open tasks in backlog
  - Gracefully handles invalid files (malformed YAML, wrong kind, non-markdown)
  - Ignores tasks-done directories (only scans tasks-open)
  - Comprehensive test coverage with 8 test cases covering edge cases and error handling
  - All quality checks pass: formatting, linting, type checking, and 483 tests (including 8 new ones)
- [x] **C-03** (S) Implement `dependency_resolver.is_unblocked(task)` – all `prerequisites` status == done
  - Created `src/trellis_mcp/dependency_resolver.py` with `is_unblocked()` function
  - Function takes TaskModel and optional project_root parameter, returns boolean indicating if task is unblocked
  - Checks all prerequisites have status="done" using existing `get_all_objects()` utility
  - Uses `clean_prerequisite_id()` to handle T- prefixes properly
  - Returns False if any prerequisite is missing or has status other than "done"
  - Returns True if no prerequisites exist (empty list means unblocked)
  - Comprehensive test coverage with 10 test cases covering all edge cases and error conditions
  - All quality checks pass: formatting, linting, type checking, and 493 tests (including 10 new ones)
- [x] **C-04** (S) Sort candidate tasks by `(priority_rank, created)` helper
  - Created `src/trellis_mcp/task_sorter.py` with `sort_tasks_by_priority()` function
  - Function takes list of TaskModel objects and returns sorted by (priority_rank, created)
  - Uses existing `priority_rank()` function for consistent priority handling
  - Primary sort: priority rank (high=1, normal=2, low=3) - lower values first
  - Secondary sort: creation date - older tasks first
  - Returns new sorted list without modifying input
  - Extracted priority_rank function to `src/trellis_mcp/models/priority_ranking.py` (one export per file)
  - Updated models package __init__.py to export priority_rank function
  - Comprehensive test coverage with 8 test cases covering priority ordering, date sorting, edge cases
  - All quality checks pass: formatting, linting, type checking, and 501 tests (including 8 new ones)
- [x] **C-05** (M) Implement `claim_next_task(projectRoot, worktreePath)` core function<br>• select first unblocked task<br>• write updated YAML (`status=in-progress`, `worktree=<path>`, `updated=<now>`)<br>• return object
  - Created `src/trellis_mcp/claim_next_task.py` with core `claim_next_task()` function
  - Function leverages existing utilities: `load_backlog_tasks()`, `is_unblocked()`, `sort_tasks_by_priority()`
  - Atomically selects highest-priority unblocked task, updates status to in-progress, optionally stamps worktree
  - Uses existing `write_object()` for atomic file writes with proper transaction semantics
  - Returns updated TaskModel object reflecting new status and metadata
  - Created `src/trellis_mcp/exceptions/no_available_task.py` with `NoAvailableTask` exception (one export per file)
  - Created `src/trellis_mcp/exceptions/__init__.py` package file to export exceptions
  - Comprehensive error handling for no tasks available and prerequisite blocking scenarios
  - All quality checks pass: formatting, linting, type checking, and 501 tests
- [x] **C-06** (XS) Wrap core function in JSON-RPC handler `claimNextTask`
  - Refactored existing `claimNextTask` JSON-RPC handler to use new core `claim_next_task()` function
  - Replaced ~150 lines of duplicate inline implementation with clean call to core function
  - Added imports for `claim_next_task` function and `NoAvailableTask` exception
  - Handled `NoAvailableTask` exception and converted to `TrellisValidationError` for API consistency
  - Mapped `TaskModel` object to expected dictionary format for API compatibility
  - Fixed priority value conversion to use string format (`str(priority)`) instead of integer (`.value`)
  - Updated return type annotation to match actual return structure
  - Removed unused imports (`get_all_objects`, `build_prerequisites_graph`)
  - All quality checks pass: formatting, linting, type checking, and 501 tests
- [x] **C-07** (S) Unit tests: priority ordering, prereq blocking, YAML update fields
  - Created comprehensive unit test suite in `tests/test_claim_next_task.py` with 17 test cases
  - **Priority Ordering Tests**: High → Normal → Low priority selection, older tasks first when tied
  - **Prerequisite Blocking Tests**: Only unblocked tasks claimable, blocked tasks properly filtered
  - **YAML Update Fields Tests**: Status changes to in-progress, updated timestamp set, worktree field handling
  - **Edge Cases**: No available tasks, no unblocked tasks, mixed task statuses, path conversion
  - Uses mocking to isolate unit under test while verifying integration with dependencies
  - All quality checks pass: formatting, linting, type checking, and 518 tests (including 17 new ones)
- [x] **C-08** (XS) Unit test: claiming when no tasks unblocked → raise `NoAvailableTask`
  - Added focused unit test `test_claiming_when_no_tasks_unblocked_raises_no_available_task` in `tests/test_claim_next_task.py`
  - Test creates multiple tasks with different priorities, all blocked by prerequisites
  - Verifies that `NoAvailableTask` exception is raised with correct message when no tasks are unblocked
  - Confirms all tasks are checked by verifying `is_unblocked` call count matches number of tasks
  - All quality checks pass: formatting, linting, type checking, and 519 tests (including 1 new test)
- [x] **C-09** (S) Integration test: create two tasks (`high`, `normal`) + satisfied prereqs, call `claimNextTask`, expect high first
  - Added `test_claim_next_task_returns_high_priority_before_normal()` to `tests/test_integration.py`
  - Test creates project → epic → feature → two tasks (normal created first, high created second)
  - Verifies claimNextTask returns high priority task first despite creation order (priority trumps age)
  - Confirms response structure includes task, claimed_status="in-progress", and file_path
  - Verifies task status is properly updated to "in-progress"
  - All quality checks pass: formatting, linting, type checking, and 520 tests (including 1 new integration test)
- [x] **C-10** (M) Integration test: two sequential calls with different `worktreePath` values → verify each task gets unique worktree stamp and persists to disk
  - Added `test_two_sequential_claims_with_different_worktree_values_persist_to_disk()` to `tests/test_integration.py`
  - Test creates project → epic → feature → two tasks (high and normal priority)
  - First claimNextTask call with worktree="workspace-1" claims high priority task
  - Second claimNextTask call with worktree="workspace-2" claims normal priority task
  - Verifies API responses contain correct worktree values at top level (`result.data["worktree"]`)
  - **Critical verification**: Reads task YAML files from disk and confirms worktree values persist
  - Verifies each task gets unique worktree stamp (workspace-1 vs workspace-2)
  - All quality checks pass: formatting, linting, type checking, and 521 tests

### Quality Gates
* Status change & file rewrite are atomic (single-process write with `with open(..., 'w')`).
* Returned Task reflects new `status` and `worktree`.
* Subsequent `claimNextTask` skips already claimed tasks.
* Tests & pre-commit hooks pass in CI matrix.

### Relevant Files
* `src/trellis_mcp/models.py` - Priority ranking utilities (C-01)
* `src/trellis_mcp/backlog_loader.py` - Backlog task loader (C-02)
* `tests/test_backlog_loader.py` - Comprehensive tests for backlog loader (C-02)
* `src/trellis_mcp/dependency_resolver.py` - Task dependency resolution logic (C-03)
* `tests/test_dependency_resolver.py` - Comprehensive tests for dependency resolver (C-03)
* `src/trellis_mcp/task_sorter.py` - Task sorting by priority and creation date (C-04)
* `src/trellis_mcp/models/priority_ranking.py` - Priority ranking function (C-04)
* `src/trellis_mcp/models/__init__.py` - Updated to export priority_rank function (C-04)
* `tests/test_task_sorter.py` - Comprehensive tests for task sorting (C-04)
* `src/trellis_mcp/claim_next_task.py` - Core task claiming function (C-05)
* `src/trellis_mcp/exceptions/no_available_task.py` - NoAvailableTask exception (C-05)
* `src/trellis_mcp/exceptions/__init__.py` - Exceptions package exports (C-05)
* `src/trellis_mcp/server.py` - Updated claimNextTask JSON-RPC handler to use core function (C-06)
* `tests/test_claim_next_task.py` - Comprehensive unit tests for claim_next_task function (C-07)
* `tests/test_integration.py` - Integration test for priority-based task claiming (C-09), worktree persistence test (C-10)
