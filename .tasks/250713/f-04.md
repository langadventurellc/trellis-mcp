# F-04 · CRUD Objects RPC — Task Checklist

## Checklist

**IMPORTANT**: When starting a new task, read @../../docs/task_mcp_spec_and_plan.md for context.

### Core File IO

- [x] **S-01** (XS) `io_utils.read_markdown(path)` → `(yaml_dict, body_str)`
  - Created `src/trellis_mcp/io_utils.py` with `read_markdown` function that delegates to existing `load_markdown` from `markdown_loader.py`
  - Added comprehensive unit tests in `tests/test_io_utils.py` covering normal cases, edge cases, and error conditions
- [x] **S-02** (XS) `io_utils.write_markdown(path, yaml_dict, body_str)` – pretty-print YAML
  - Implemented `write_markdown` function in `src/trellis_mcp/io_utils.py` with atomic file writing
  - Added `_serialize_yaml_dict` helper function for datetime/enum serialization

### Validation Helpers

- [x] **S-03** (S) `validators.validate_front_matter(yaml_dict, kind)` – required fields, enums
  - Implemented `validate_front_matter` function in `src/trellis_mcp/validation.py` that validates YAML front matter
  - Function validates required fields per kind (project, epic, feature, task) and enum values (kind, status, priority)
  - Avoids duplicate error messages by intelligently handling missing vs invalid fields
- [x] **S-04** (S) `validators.enforce_status_transition(old, new, kind)` per lifecycle table
  - Implemented `enforce_status_transition` function in `src/trellis_mcp/validation.py` that validates status transitions according to lifecycle specifications
  - Function supports all four object kinds (task, feature, epic, project) with proper transition rules
  - Task transitions: open → in-progress → review → done, with shortcuts (open → done, in-progress → done) 
  - Feature/Epic/Project transitions: draft → in-progress → done
- [x] **S-05** (S) `validators.check_prereq_cycles(projectRoot)` – DFS cycle check
  - Implemented `check_prereq_cycles` function in `src/trellis_mcp/validation.py` as a simple boolean wrapper around existing `validate_acyclic_prerequisites` function
  - Function takes `project_root: str | Path` parameter and returns `bool` (True = no cycles, False = cycles detected)
  - Added comprehensive test coverage in `tests/test_validation.py` with 8 test cases covering empty projects, valid structures, cycles, self-references, and path handling
  - Function handles both `CircularDependencyError` exceptions and error lists from underlying validation logic

### RPC Implementations

- [x] **S-06** (S) **createObject** handler: generate ID (if missing), validate, write file
  - Updated the `createObject` handler in `src/trellis_mcp/server.py` to use comprehensive validation
  - Now uses `validate_front_matter()` and `validate_object_data()` from `validation.py`
  - Implements acyclic prerequisites validation using `check_prereq_cycles()`
  - Uses `write_markdown()` from `io_utils.py` for atomic file writing
  - Proper error handling with `TrellisValidationError` for validation failures
  - Rollback mechanism if prerequisite cycles are detected after file creation
- [x] **S-07** (XS) **getObject** handler: resolve path, read & return YAML+body
  - Implemented `getObject` handler in `src/trellis_mcp/server.py` that retrieves Trellis MCP objects by kind and ID
  - Added comprehensive parameter validation for kind, id, and projectRoot
  - Uses `id_to_path` to resolve object file paths and `read_markdown` to parse YAML front-matter and body
  - Returns structured data with YAML dictionary, body content, file path, kind, and clean ID
  - Handles all object types (project, epic, feature, task) including tasks in both open and done directories
  - Automatically strips ID prefixes (P-, E-, F-, T-) to return clean IDs
  - Provides proper error handling for missing objects, invalid kinds, and malformed YAML
- [x] **S-08** (S) **updateObject** handler: merge patch, re-validate, write file
  - Implemented comprehensive `updateObject` handler in `src/trellis_mcp/server.py` with JSON merge patch support
  - Added `_deep_merge_dict` helper function for recursive dictionary merging to avoid overwriting nested structures
  - Supports both `yamlPatch` (for YAML front-matter updates) and `bodyPatch` (for Markdown body replacement)
  - Comprehensive validation pipeline: front-matter validation, object data validation, status transition validation, and acyclic prerequisites validation
  - Atomic file operations with rollback on validation failures
  - Proper error handling for missing objects, invalid patches, and validation failures
  - Returns structured response with change summary and updated object information
- [x] **S-09** (S) **listBacklog** handler: glob tasks within scope, filter by status/priority
  - Implemented comprehensive `listBacklog` handler in `src/trellis_mcp/server.py` that searches through the planning directory structure to find tasks
  - Added support for scope filtering (project/epic/feature ID), status filtering (open, in-progress, review, done), and priority filtering (high, normal, low)
  - Function searches both tasks-open and tasks-done directories across the entire project hierarchy
  - Tasks are parsed from YAML front-matter and returned with structured metadata (id, title, status, priority, parent, file_path, timestamps)
  - Implemented proper priority-based sorting (high → normal → low) with secondary sorting by creation date
  - Added comprehensive error handling for file parsing and proper parameter validation
  - Follows existing server patterns with consistent type annotations and docstrings

### Tests

- [x] **S-10** (XS) Unit tests for read/write round-trip
  - Added comprehensive round-trip tests to `tests/test_io_utils.py` in the `TestWriteMarkdown` class
  - `test_write_markdown_datetime_roundtrip_consistency`: Tests datetime objects through multiple write/read cycles
  - `test_write_markdown_enum_roundtrip_consistency`: Tests enum objects through multiple write/read cycles  
  - `test_write_markdown_comprehensive_roundtrip`: Tests mixed data types (datetime, enums, complex structures) through multiple cycles
  - `test_write_markdown_edge_cases_roundtrip`: Tests special characters, unicode, multiline content, and edge cases
  - All tests verify consistency across multiple write/read cycles to ensure no data corruption or serialization drift
  - Tests cover datetime serialization, enum serialization, complex nested structures, and special character handling
- [x] **S-11** (S) Unit tests for status-transition enforcement (good & bad paths)
  - Enhanced comprehensive test coverage in `tests/test_validation.py` with 6 additional test methods
  - Added complete transition matrices for epic and feature objects (matching project coverage)
  - Added edge case testing for empty strings, whitespace-only strings, and invalid parameters
  - Added comprehensive terminal status testing for all object kinds
  - Added cross-kind status validation tests (task-specific statuses rejected for other kinds)
  - Added specific error message validation tests for different failure scenarios
  - All 20 status transition tests pass, covering both valid (good) and invalid (bad) transition paths
- [x] **S-12** (S) Integration test: create epic → feature → tasks; list backlog; update statuses; verify YAML on disk
  - Implemented comprehensive integration test `test_crud_epic_feature_tasks_workflow_with_yaml_verification` in `tests/test_integration.py`
  - Test creates project → epic → feature → tasks hierarchy and validates all CRUD operations
  - Tests listBacklog with different scope, status, and priority filters
  - Tests status transitions for tasks (open → in-progress → review)
  - Validates that tasks cannot be set to 'done' via updateObject (must use completeTask)
  - Verifies all YAML files are correctly written to disk with proper content and structure
  - Confirms getObject retrieval works for all object types
  - All assertions pass, validating the complete CRUD workflow

### Quality Gates
* All schema v 1.0 rules enforced (acyclic prereqs, valid parent, enum values).
* Invalid operations raise `MCPValidationError` with clear message.
* Unit test coverage ≥ 90 % for validators and RPC handlers.
* No external side effects: CRUD only touches `planning/` tree.