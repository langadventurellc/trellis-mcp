# F-07 · Task Completion Flow — Task Checklist

## Checklist

**IMPORTANT**: When starting a new task, read @../../docs/task_mcp_spec_and_plan.md for context.

- [x] **S-01** (XS) Define `CompletionError` exceptions (prereqs-open, bad-status)
  - Created `PrerequisitesNotComplete` exception for tasks with incomplete prerequisites
  - Created `InvalidStatusForCompletion` exception for tasks not in valid completion status
  - Updated exceptions package to export both new exceptions
  - Files changed: `src/trellis_mcp/exceptions/prerequisites_not_complete.py`, `src/trellis_mcp/exceptions/invalid_status_for_completion.py`, `src/trellis_mcp/exceptions/__init__.py`
- [x] **S-02** (S) `complete_task()` service fn: validate task is **in-progress / review**
  - Created core service function `complete_task()` that validates task status for completion
  - Validates task status is either `in-progress` or `review` before allowing completion
  - Raises `InvalidStatusForCompletion` exception for invalid statuses 
  - Added RPC method `completeTask` to server.py following existing patterns
  - Comprehensive test coverage for valid/invalid statuses, input validation, and error handling
  - Files changed: `src/trellis_mcp/complete_task.py`, `src/trellis_mcp/server.py`, `tests/test_complete_task.py`
- [x] **S-03** (S) Ensure **all prerequisites are `done`** before allowing completion
  - Extended `complete_task()` function to validate prerequisites using existing `is_unblocked()` logic
  - Added import for `PrerequisitesNotComplete` exception and `is_unblocked` from `dependency_resolver`
  - Added prerequisite validation after status validation, raising `PrerequisitesNotComplete` when prerequisites are incomplete
  - Updated function docstring to document new validation behavior
  - Added comprehensive test class `TestCompleteTaskPrerequisites` with 4 test cases covering all scenarios
  - Files changed: `src/trellis_mcp/complete_task.py`, `tests/test_complete_task.py`
- [x] **S-04** (S) Append `### Log` entry with timestamp, `summary`, and `filesChanged[]`
  - Extended `complete_task()` function to accept optional `summary` and `files_changed` parameters
  - Added `_append_log_entry()` helper function that reads task file, appends formatted log entry with timestamp and filesChanged array
  - Updated RPC method `completeTask` to accept `summary` and `filesChanged` parameters and pass them to core function
  - Implemented log entry format: `**2025-07-15T12:34:56.789Z** - Summary text` with optional `- filesChanged: ["file1.py", "file2.py"]`
  - Added comprehensive test coverage for log appending scenarios: with/without files, with/without existing log section, and no summary case
  - All quality checks passing: formatting, linting, type checking, and tests
  - Files changed: `src/trellis_mcp/complete_task.py`, `src/trellis_mcp/server.py`, `tests/test_complete_task.py`
- [x] **S-05** (XS) Move file to `tasks-done/<ISO>-<id>.md`, preserve front-matter
  - Extended `complete_task()` function to actually move task files from `tasks-open` to `tasks-done` directory after validation
  - Implemented `_move_task_to_done()` helper function that handles file movement, YAML front-matter updates, and atomic operations
  - Added timestamp prefix to done task filenames using format `YYYYMMDD_HHMMSS-T-{id}.md` for consistency with existing path resolver
  - Updates YAML front-matter: sets `status: "done"` and clears `worktree: null` field as specified in S-06 requirements
  - Uses existing `resolve_path_for_new_object()` utility with `status="done"` to generate correct destination paths
  - Preserves all existing front-matter fields, only updating status and worktree as required
  - Uses atomic file operations via existing `write_markdown()` utility followed by removal of original file
  - Updated all existing tests to mock the new file movement functionality while preserving existing validation test coverage
  - Added comprehensive integration test `test_complete_task_moves_file_to_done` that verifies actual file movement behavior
  - All quality checks passing: formatting, linting, type checking, and comprehensive test suite
  - Files changed: `src/trellis_mcp/complete_task.py`, `tests/test_complete_task.py`, `tests/test_complete_task_file_movement.py`
- [x] **S-06** (XS) Clear `worktree` field and set `status=done` in YAML
  - Added comprehensive test validation for YAML front-matter in moved task files
  - Verified that `complete_task()` correctly sets `status: "done"` and `worktree: null` in the YAML front-matter of moved files
  - Enhanced `test_complete_task_moves_file_to_done` test to validate the actual YAML content using `read_markdown()`
  - Confirms S-06 requirement is fully implemented with proper test coverage
  - Files changed: `tests/test_complete_task_file_movement.py`
- [x] **S-07** (M) Update parent **feature** status to `in-progress` → `done` when last child task completes
  - Extended `complete_task()` function to check parent feature status after task completion
  - Added `_check_and_update_parent_feature_status()` helper function to handle feature status updates
  - Added `_get_all_feature_tasks()` helper function to scan both tasks-open and tasks-done directories for a feature
  - Added `_update_feature_status()` helper function to update feature YAML front-matter with proper timestamp
  - Only updates feature status if feature is currently `in-progress` and ALL child tasks are `done`
  - Uses defensive error handling to prevent task completion from failing due to feature update issues
  - Added comprehensive test coverage with 5 test cases covering all scenarios: parent update calls, no parent handling, all tasks done, mixed task statuses, and already done features
  - All quality checks passing: formatting, linting, type checking, and comprehensive test suite (548 tests pass)
  - Files changed: `src/trellis_mcp/complete_task.py`, `tests/test_complete_task.py`
- [x] **S-08** (XS) Unit tests: happy path, prereq-open error, wrong-status error
  - Created focused unit test class `TestCompleteTaskS08Core` with three core test methods
  - `test_happy_path_task_completion` - Tests successful completion of task in valid status with no prerequisite issues
  - `test_prereq_open_error` - Tests `PrerequisitesNotComplete` exception when task has incomplete prerequisites
  - `test_wrong_status_error` - Tests `InvalidStatusForCompletion` exception when task has invalid status (not in-progress/review)
  - All tests use proper mocking to isolate the specific scenarios being tested
  - All quality checks passing: formatting, linting, type checking, and comprehensive test suite (551 tests pass)
  - Files changed: `tests/test_complete_task_s08_unit_tests.py`
- [x] **S-09** (XS) Integration test: claim → modify file list → complete → verify move & YAML
  - Created comprehensive integration test `test_integration_s09_claim_complete_workflow.py` that tests the complete end-to-end workflow
  - Tests full project hierarchy creation → task claiming → task completion → file movement verification
  - Verifies RPC calls: `createObject`, `claimNextTask`, `completeTask` work together correctly
  - Validates task file moves from `tasks-open/` to `tasks-done/` with proper timestamp prefix format
  - Confirms YAML front-matter updates: status=done, worktree=null, and log entry with summary and filesChanged
  - Tests complete task completion lifecycle including priority handling and file system changes
  - All quality checks passing: formatting, linting, type checking, and comprehensive test suite (552 tests pass)
  - Files changed: `tests/test_integration_s09_claim_complete_workflow.py`
- [x] **S-10** (S) CLI helper `trellis-mcp complete-ID --summary … --files …` for manual runs
  - Created new `complete` CLI command following existing Click patterns and conventions
  - Takes required `task_id` argument and optional `--summary` and `--files` options  
  - `--files` option supports multiple values using `multiple=True` parameter
  - Integrates with existing `complete_task()` function from core service layer
  - Follows established error handling patterns with `click.ClickException` and debug mode support
  - Provides user-friendly feedback showing completion details (task title, ID, status, summary, files)
  - Includes comprehensive help text with usage examples and proper CLI documentation
  - All quality checks passing: formatting, linting, type checking, and comprehensive test suite (552 tests pass)
  - Files changed: `src/trellis_mcp/cli.py`

### Quality Gates
* Completing a task leaves **no file** in `tasks-open/`.
* Parent feature auto-closes only when **all** child tasks are done.
* Log entry contains ISO timestamp, user summary, and list of relative file paths.
* All unit & integration tests pass on CI matrix with coverage ≥ 90 % for new code.
